@page "/contacts/addContactForm"

@using Notebook.Domain.Requests
@using System.Text.Json
@inject NavigationManager NavigationManager
@inject HttpClient httpClient
@rendermode InteractiveServer

<MudStack Justify="Justify.Center">
    <MudItem xs="12" sm="7">
        <MudPaper Class="pa-4">
            <MudForm @ref="mudForm" @bind-IsValid="isValid" Model="@newContact">
                <MudTextField Label="First Name" @bind-Value="newContact.FirstName" For="@(() => newContact.FirstName)"
                    Required="true" RequiredError="First name is required!" />
                <MudTextField Label="Last Name" @bind-Value="newContact.LastName" For="@(() => newContact.LastName)"
                    Required="true" RequiredError="Last name is required!" />
                <MudTextField Label="Phone number" @bind-Value="newContact.PhoneNumber" For="@(() => newContact.PhoneNumber)"
                    Required="true" RequiredError="Phone number is required!" />
                <MudTextField Label="Email" @bind-Value="newContact.Email" For="@(() => newContact.Email)" />
            </MudForm>
        </MudPaper>
        <MudPaper Class="pa-4 mt-4">
            <div style="display:flex; justify-content: flex-end;">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" DropShadow="false" OnClick="@((e) => AddContact())">Add</MudButton>
                <div style="margin-left: 1rem;"/>
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" DropShadow="false" OnClick="@((e) => Back())">Cancel</MudButton>
            </div>
        </MudPaper>
    </MudItem>

    <MudItem>
        
    </MudItem>
</MudStack>

<MudTable Items="@recentContacts">
    <ToolBarContent>
        <MudText>Recently added contacts</MudText>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>First Name</MudTh>
        <MudTh>Last Name</MudTh>
        <MudTh>Phone number</MudTh>
        <MudTh>Email</MudTh>
        <MudTh>Date of Birth</MudTh>
    </HeaderContent>
    <RowTemplate>
        @foreach (var contact in recentContacts)
        {
            <MudTd DataLabel="First Name">@context.FirstName</MudTd>
            <MudTd DataLabel="Last Name">@context.LastName</MudTd>
            <MudTd DataLabel="Phone number">@context.PhoneNumber</MudTd>
            <MudTd DataLabel="Email">@context.Email</MudTd>
            <MudTd DataLabel="Data of Birth">@context.DateOfBirth</MudTd>
        }
    </RowTemplate>
</MudTable>

@code
{
    private MudForm mudForm;
    private bool isValid;
    private ContactForCreateDTO newContact = new ContactForCreateDTO();
    private Uri addContactUri;

    private List<ContactForCreateDTO> recentContacts;

    protected override async Task OnInitializedAsync()
    {
        string addContactControllerUri = "/api/contacts/add";
        addContactUri = new Uri(httpClient.BaseAddress, addContactControllerUri);
        recentContacts = new List<ContactForCreateDTO>();
    }

    private async Task Back()
    {
        if (isValid)
        {
            await mudForm.ResetAsync();
        }
        else
        {
            NavigationManager.NavigateTo("/contacts");
        }
    }

    private async Task AddContact()
    {
        var response = await httpClient.PostAsJsonAsync(addContactUri, newContact);

        if (response.IsSuccessStatusCode)
        {
            recentContacts.Add(newContact);
            StateHasChanged();

            if(mudForm != null)
            {
                await mudForm.ResetAsync();
            }
        }
    }
}
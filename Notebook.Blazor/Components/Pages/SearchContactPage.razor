@page "/contacts/searchContact"

@using Notebook.Domain.Entities
@using Notebook.Domain.Requests
@using Notebook.Shared.RequestFeatures
@inject NavigationManager NavigationManager
@inject HttpClient httpClient

@rendermode InteractiveServer

<MudPaper Height="400px" Width="100%">
        <MudStack Justify="Justify.FlexStart" Row="true">
            <MudPaper Class="pa-4" Style="width:50%">
                <MudStack Row="true">
                    <MudSwitch Class="pa-1" @bind-Value="_searchAllContacts">
                            @if (!_searchAllContacts)
                            {
                                _disabledSearchButton = false;
                                <MudText>Switch to searching through fields</MudText>
                            }
                            else
                            {
                                _disabledSearchButton = true;
                                <MudText>Switch to searching all contacts</MudText>
                            }
                    </MudSwitch>

                    <MudSpacer/>

                    <MudButton Disabled="@_disabledSearchButton" Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => SearchAllContacts())">SEARCH</MudButton>

                </MudStack>
            </MudPaper>

            <MudPaper Class="pa-4" Style="width:50%">

            @if (_searchAllContacts)
            {
                <MudStack Justify="Justify.FlexEnd">
                    <MudItem xs="12" sm="7">
                        <MudPaper Class="pa-4 border-solid border-2 mud-border-primary">
                            <MudForm @ref="_mudForm">
                                <MudTextField T="string" Label="First Name" />
                                <MudTextField T="string" Label="Last Name" />
                                <MudTextField T="string" Label="Phone number" />
                                <MudTextField T="string" Label="Email" />
                            </MudForm>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="7">
                        <MudPaper>
                            <MudItem class="mr-6 mt-1">
                                <MudButton style="float: right" Variant="Variant.Filled" Color="Color.Dark" DropShadow="false">Search</MudButton>
                            </MudItem>
                        </MudPaper>
                    </MudItem>
                </MudStack>
            }

            </MudPaper>
        </MudStack>
</MudPaper>



    <MudItem Class="mr-4 mt-1">
        

        @if(_showTable)
        {
            <MudTable Items="@_allContacts">
                <HeaderContent>
                    <MudTh>Id</MudTh>
                    <MudTh>First Name</MudTh>
                    <MudTh>Last Name</MudTh>
                    <MudTh>Phone Number</MudTh>
                    <MudTh>Email</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="First Name">@context.FirstName</MudTd>
                    <MudTd DataLabel="Last Name">@context.LastName</MudTd>
                    <MudTd DataLabel="Phone Number">@context.PhoneNumber</MudTd>
                    <MudTd DataLabel="Email">@context.Email</MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudItem>

@code
{
    private MudForm? _mudForm;
    private bool _searchAllContacts = false;
    private bool _disabledSearchButton;
    private bool _showTable;
    private Uri? _getAllContactsUri;
    private IEnumerable<ContactForCreateDTO>? _allContacts = new List<ContactForCreateDTO>();

    protected override async Task OnInitializedAsync()
    {
        const string allContactControllerUri = "/api/contacts/getAllContacts";
        _getAllContactsUri = new Uri(httpClient.BaseAddress!, allContactControllerUri);
    }

    private async Task SearchAllContacts()
    {
        //var uri = $"{_getAllContactsUri}?PageNumber={pageNumber}";
        var response = await httpClient.GetAsync($"{_getAllContactsUri}?PageNumber={1}");

        if (response.IsSuccessStatusCode)
        {
            _allContacts = await response.Content.ReadFromJsonAsync<List<ContactForCreateDTO>>();

            if (_allContacts.Any())
            {
                _showTable = true;
            }
        }
        else
        {
            _allContacts = new List<ContactForCreateDTO>();
        }
        
    }
}